<link rel="import" href="../polymer/polymer.html"/>
<!--
@demo demo/full.html Full Demo
-->
<dom-module id="cosmoz-grouped-list-template-selector">
	<template>
		<style>
			:host ::slotted([hidden]) {
				display: none !important;
			}

			/* This will give a row with an opened dropdown a z-index higher than all other rows */
			:host(.has-dropdown) {
				z-index: 100;
			}
		</style>
		<slot></slot>
	</template>
	<script>
		'use strict';
		Polymer({

			is: 'cosmoz-grouped-list-template-selector',

			properties: {
				item: {
					type: Object,
					observer: '_itemChanged'
				},
			},

			selectorId: null,

			elements: null,

			currentElement: null,

			currentTemplateId: null,

			groupedList: null,

			created() {
				this.elements = {};
			},

			ready() {
				// HACK(pasleq) Because iron-list uses `translate3d` transform on row template instances,
				// a new stacking context is created for each row, preventing a dropdown to overflow the rows beneath.
				// In order to workaround this issue, increase the z-index of the row if it has an opened dropdown
				this.listen(this, 'paper-dropdown-open', '_onDropdownOpen');
				this.listen(this, 'paper-dropdown-close', '_onDropdownClose');
			},

			detached() {
				this.unlisten(this, 'paper-dropdown-open', '_onDropdownOpen');
				this.unlisten(this, 'paper-dropdown-close', '_onDropdownClose');
			},

			show(element, templateId) {
				if (this.currentElement && element !== this.currentElement) {
					this.currentElement.setAttribute('hidden', '');
				}

				element.removeAttribute('hidden');

				this.currentElement = element;
				this.currentTemplateId = templateId;
			},

			_itemChanged(newItem) {
				let slot;

				if (this.selectorId === null) {
					// Notifies parent cosmoz-grouped-list that a new template-selector
					// has been added so that it gets a selectorId
					this.fire('template-selector-created', {
						selector: this
					}, {
						bubbles: false
					});

					this.slotName = 'selectorSlot' + this.selectorId;
					slot = Polymer.dom(this).querySelector('slot');
					if (slot !== null) {
						slot.setAttribute('name', this.slotName);
					} else {
						slot = Polymer.dom(this).querySelector('content');
						slot.setAttribute('select', '[slot="' + this.slotName + '"]');
						slot.setAttribute('name', this.slotName);
					}
				}

				this.groupedList.selectorItemChanged(this, newItem);
			},

			_onDropdownOpen(event) { // eslint-disable-line
				this.classList.add('has-dropdown');
			},

			_onDropdownClose(event) { // eslint-disable-line
				this.classList.remove('has-dropdown');
			}
		});
	</script>
</dom-module>
