<link rel="import" href="../shadycss/apply-shim.html">
<link rel="import" href="../polymer/polymer-element.html"/>
<!--
@demo demo/full.html Full Demo
-->
<dom-module id="cosmoz-grouped-list-template-selector">
	<template>
		<style>
			:host ::slotted([hidden]) {
				display: none !important;
			}

			/* This will give a row with an opened dropdown a z-index higher than all other rows */
			:host(.has-dropdown) {
				z-index: 100;
			}
		</style>
		<slot></slot>
	</template>
	<script>
	(function () {
		'use strict';

		class TemplateSelector extends Polymer.Element {
			static get is() {
				return 'cosmoz-grouped-list-template-selector';
			}
			static get properties() {
				return {
					index: {
						type: Number
					},
					item: {
						type: Object,
						observer: '_onItemChanged'
					},
					hidden: {
						type: Boolean,
						observer: '_onHiddenChanged'
					},
				};
			}

			constructor() {
				super();
				this._onDropdownOpen = this._onDropdownOpen.bind(this);
				this._onDropdownClose = this._onDropdownClose.bind(this);
			}

			connectedCallback() {
				super.connectedCallback();

				this.addEventListener('paper-dropdown-open', this._onDropdownOpen);
				this.addEventListener('paper-dropdown-close', this._onDropdownClose);

				const {index, item, hidden} = this;

				if (index == null && item == null) {
					return;
				}
				this._fireChange({index, item, hidden});
			}

			disconnectedCallback() {
				super.disconnectedCallback();
				this.removeEventListener('paper-dropdown-open', this._onDropdownOpen);
				this.removeEventListener('paper-dropdown-close', this._onDropdownClose);
				this._fireChange({hidden: true});
			}

			_onItemChanged(item) {
				const {index, hidden} = this;
				if (item == null || hidden) {
					return;
				}
				this._fireChange({index, item});
			}

			_onHiddenChanged(hidden) {
				const {index, item} = this;
				this._fireChange({index, hidden, item});
			}

			_fireChange(props = {}) {
				this.dispatchEvent(new CustomEvent('cosmoz-selector-changed', {
					bubbles: true,
					composed: true,
					detail: {
						selector: this,
						...props
					}
				}));
			}

			_onDropdownOpen(event) { // eslint-disable-line no-unused-vars
				this.classList.add('has-dropdown');
			}

			_onDropdownClose(event) { // eslint-disable-line no-unused-vars
				this.classList.remove('has-dropdown');
			}

		}
		customElements.define(TemplateSelector.is, TemplateSelector);
	})();
	</script>
</dom-module>
