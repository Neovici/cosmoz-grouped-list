<link rel="import" href="../polymer/polymer.html"/>
<!--
@demo demo/full.html Full Demo
-->
<dom-module id="cosmoz-grouped-list-template-selector">
	<template>
		<style>
			:host ::slotted([hidden]) {
				display: none !important;
			}
		</style>
		<slot></slot>
	</template>
	<script>
		'use strict';
		Polymer({

			is: 'cosmoz-grouped-list-template-selector',

			properties: {
				item: {
					type: Object,
					observer: '_itemChanged'
				},
			},

			selectorId: null,

			elements: null,

			currentElement: null,

			currentTemplateId: null,

			groupedList: null,

			created() {
				this.elements = {};
			},

			show(element, templateId) {
				if (this.currentElement && element !== this.currentElement) {
					this.currentElement.setAttribute('hidden', '');
				}

				element.removeAttribute('hidden');

				this.currentElement = element;
				this.currentTemplateId = templateId;
			},

			_itemChanged(newItem) {
				let slot;

				if (this.selectorId === null) {
					// Notifies parent cosmoz-grouped-list that a new template-selector
					// has been added so that it gets a selectorId
					this.fire('template-selector-created', {
						selector: this
					}, {
						bubbles: false
					});

					this.slotName = 'selectorSlot' + this.selectorId;
					slot = Polymer.dom(this).querySelector('slot');
					if (slot !== null) {
						slot.setAttribute('name', this.slotName);
					} else {
						slot = Polymer.dom(this).querySelector('content');
						slot.setAttribute('select', '[slot="' + this.slotName + '"]');
						slot.setAttribute('name', this.slotName);
					}
				}
				this.groupedList.selectorItemChanged(this, newItem);
			},

			detached() {
				this.dataHost = null;
				this.groupedList = null;
				this._templateInstance = null;

				if (!this.elements) {
					return;
				}

				Object
					.keys(this.elements)
					.forEach(key => {
						const el = this.elements[key];
						el.__tmplInstance = null;
						el._templateInstance = null;
						el.dataHost = null;
					});
				this.elements = {};
			},

		});
	</script>
</dom-module>
